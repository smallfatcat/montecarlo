(function(){"use strict";const $=["Clubs","Diamonds","Hearts","Spades"],z=["A","2","3","4","5","6","7","8","9","10","J","Q","K"];function G(){const e=[];for(const t of $)for(const n of z)e.push({rank:n,suit:t});return e}function w(e){if(!Number.isInteger(e)||e<=0)throw new Error("numberOfDecks must be a positive integer");const t=[];for(let n=0;n<e;n+=1)t.push(...G());return t}function T(e,t=Math.random){for(let n=e.length-1;n>0;n-=1){const s=Math.floor(t()*(n+1));[e[n],e[s]]=[e[s],e[n]]}return e}const V={smallBlind:1,bigBlind:2};function C(e){return{...e,deck:[...e.deck],community:[...e.community],seats:e.seats.map(t=>({...t,hole:[...t.hole]})),pot:{...e.pot},rules:{...e.rules}}}function X(e){return e.rules.bigBlind}function _(e,t){const n=e.length;for(let s=1;s<=n;s+=1){const r=(t+s)%n,a=e[r];if(!a.hasFolded&&!a.isAllIn&&a.stack>0)return r}return null}function B(e,t){const n=e.length;for(let s=1;s<=n;s+=1){const r=(t+s)%n;if(e[r].stack>0)return r}return null}function Y(e){return e.filter(t=>!t.hasFolded&&t.stack>0).length}const F={poker:{rakePercent:0,blinds:{increaseEveryHands:50,increaseFactor:2}}},Z=Object.fromEntries(["2","3","4","5","6","7","8","9","10","J","Q","K","A"].map((e,t)=>[e,t]));function b(e,t){return t-e}function I(e){return Z[e.rank]}function W(e){for(let t=1;t<e.length;t+=1)if(e[t-1]-1!==e[t])return!1;return!0}function P(e){return Array.from(new Set(e)).sort(b)}function tt(e){if(e.length!==7)throw new Error("evaluateSeven expects exactly 7 cards");const t=new Map,n=new Map;for(const o of e){const c=I(o);t.set(c,(t.get(c)??0)+1);const l=o.suit,u=n.get(l)??[];u.push(o),n.set(l,u)}for(const[,o]of n)if(o.length>=5){const c=o.map(I).sort(b),l=P(c),u=l.includes(12)?[...l,-1]:l;for(let h=0;h+4<u.length;h+=1){const k=u.slice(h,h+5);if(W(k))return{class:"straight_flush",ranks:[k[0]===-1?3:k[0],...k.slice(1)]}}}const s=Array.from(t.entries()).map(([o,c])=>({v:o,n:c})).sort((o,c)=>c.n-o.n||c.v-o.v),r=s.find(o=>o.n===4);if(r){const o=s.filter(c=>c.v!==r.v).map(c=>c.v).sort(b);return{class:"four_kind",ranks:[r.v,o[0]]}}const a=s.filter(o=>o.n===3),i=s.filter(o=>o.n===2);if(a.length>=2||a.length>=1&&i.length>=1){const o=a[0],c=a.length>=2?{v:a[1].v}:{v:i[0].v};return{class:"full_house",ranks:[o.v,c.v]}}for(const[,o]of n)if(o.length>=5)return{class:"flush",ranks:o.map(I).sort(b).slice(0,5)};{const o=P(e.map(I)),c=o.includes(12)?[...o,-1]:o;for(let l=0;l+4<c.length;l+=1){const u=c.slice(l,l+5);if(W(u))return{class:"straight",ranks:[u[0]===-1?3:u[0],...u.slice(1)]}}}if(a.length>=1){const o=a[0],c=s.filter(l=>l.n===1).map(l=>l.v).sort(b).slice(0,2);return{class:"three_kind",ranks:[o.v,...c]}}if(i.length>=2){const[o,c]=i.slice(0,2).sort((u,h)=>h.v-u.v),l=s.filter(u=>u.n===1).map(u=>u.v).sort(b)[0];return{class:"two_pair",ranks:[o.v,c.v,l]}}if(i.length===1){const o=i[0],c=s.filter(l=>l.n===1).map(l=>l.v).sort(b).slice(0,3);return{class:"pair",ranks:[o.v,...c]}}return{class:"high_card",ranks:P(e.map(I)).slice(0,5)}}function v(e){for(;;){const t=e.pop();if(t)return t;e.push(...T(w(6)))}}function et(e,t,n=200,s){const r=Array.from({length:e},(a,i)=>({seatIndex:i,isCPU:t.includes(i),hole:[],stack:n,committedThisStreet:0,totalCommitted:0,hasFolded:!1,isAllIn:!1}));return{handId:0,deck:T(w(6)),community:[],seats:r,buttonIndex:0,street:null,status:"idle",currentToAct:null,lastAggressorIndex:null,betToCall:0,lastRaiseAmount:V.bigBlind,pot:{main:0},rules:{...V},gameOver:!1}}function nt(e){const t=C(e);if(t.gameOver)return t;const n=F.poker.blinds?.increaseEveryHands,s=F.poker.blinds?.increaseFactor;if(t.handId>0&&t.handId%n===0&&(t.rules.smallBlind=Math.max(1,t.rules.smallBlind*s),t.rules.bigBlind=Math.max(1,t.rules.bigBlind*s)),t.deck.length<20&&(t.deck=T(w(6))),t.handId+=1,t.community=[],t.seats=t.seats.map(c=>({...c,hole:[],committedThisStreet:0,totalCommitted:0,hasFolded:c.stack<=0,isAllIn:!1})),t.pot={main:0},t.lastRaiseAmount=t.rules.bigBlind,t.betToCall=0,t.street="preflop",t.status="in_hand",t.seats.filter(c=>c.stack>0).length<2)return t.status="hand_over",t.gameOver=!0,t;const a=B(t.seats,t.buttonIndex),i=B(t.seats,a);q(t,a,t.rules.smallBlind),q(t,i,t.rules.bigBlind);const f=t.seats.filter(c=>c.stack>0).length*2;t.deck.length<f&&(t.deck=T(w(6)));for(let c=0;c<2;c+=1)for(let l=0;l<t.seats.length;l+=1){const u=(t.buttonIndex+1+l)%t.seats.length,h=t.seats[u];h.stack<=0||h.hole.push(v(t.deck))}return t.seats.filter(c=>c.stack>0).length<2?(t.status="hand_over",t.gameOver=!0,t):(t.currentToAct=_(t.seats,i),t.currentToAct==null?R(t):(t.lastAggressorIndex=i,t.betToCall=Math.max(...t.seats.map(c=>c.committedThisStreet)),t))}function q(e,t,n){const s=e.seats[t];if(s.stack<=0)return;const r=Math.min(s.stack,n);s.stack-=r,s.committedThisStreet+=r,s.totalCommitted+=r,e.pot.main+=r,s.stack===0&&(s.isAllIn=!0)}function st(e){if(e.status!=="in_hand"||e.currentToAct==null)return[];const t=e.seats[e.currentToAct];if(t.isAllIn||t.hasFolded)return[];const n=e.betToCall-t.committedThisStreet,s=n<=0,r=e.betToCall>0,a=r&&!t.isAllIn&&t.stack>n,i=s&&!r&&t.stack>0,f=["fold"];return s?f.push("check"):f.push("call"),i&&f.push("bet"),a&&f.push("raise"),f}function rt(e,t){if(e.status!=="in_hand"||e.currentToAct==null)return e;const n=C(e),s=n.currentToAct,r=n.seats[s];if(r.hasFolded||r.isAllIn)return n;const a=Math.max(0,n.betToCall-r.committedThisStreet),i=X(n);switch(t.type){case"fold":{r.hasFolded=!0;break}case"check":{if(a>0)throw new Error("Cannot check facing a bet");break}case"call":{if(a<=0)throw new Error("Nothing to call");const u=Math.min(r.stack,a);O(n,r,u);break}case"bet":{if(a>0)throw new Error("Cannot bet facing a bet");const u=Math.max(t.amount??i,i),h=Math.min(r.stack,u);O(n,r,h),n.betToCall=r.committedThisStreet,n.lastRaiseAmount=h,n.lastAggressorIndex=r.seatIndex;break}case"raise":{if(n.betToCall<=0)throw new Error("Nothing to raise");const u=Math.max(n.lastRaiseAmount,i),h=Math.max(t.amount??u,0),k=Math.max(0,r.stack-a),x=Math.min(h,k),d=Math.min(r.stack,a+x);if(d<=0)return n;const g=r.committedThisStreet;O(n,r,d),n.betToCall=Math.max(n.betToCall,r.committedThisStreet);const A=r.committedThisStreet-g-a;A>=u&&(n.lastRaiseAmount=A,n.lastAggressorIndex=r.seatIndex);break}default:return n}if(Y(n.seats)<=1)return R(n);const f=_(n.seats,s),o=n.seats.filter(u=>!u.hasFolded&&!u.isAllIn&&u.hole.length===2),c=o.length===0,l=c||o.every(u=>u.committedThisStreet===n.betToCall);if(c)return K(n);if(l){const u=n.lastAggressorIndex;if(u!=null){if(s===u)return K(n);if(f===u)return n.currentToAct=f,n}return K(n)}return n.currentToAct=f,n}function O(e,t,n){const s=Math.min(n,t.stack);t.stack-=s,t.committedThisStreet+=s,t.totalCommitted+=s,e.pot.main+=s,t.stack===0&&(t.isAllIn=!0)}function at(e){e.seats.forEach(t=>t.committedThisStreet=0),e.betToCall=0,e.lastRaiseAmount=e.rules.bigBlind,e.lastAggressorIndex=null}function K(e){const t=C(e);if(t.street==="preflop")t.community.push(v(t.deck),v(t.deck),v(t.deck)),t.street="flop";else if(t.street==="flop")t.community.push(v(t.deck)),t.street="turn";else if(t.street==="turn")t.community.push(v(t.deck)),t.street="river";else if(t.street==="river")return t.street="showdown",R(t);at(t);let n=_(t.seats,t.buttonIndex);if(n==null)return R(t);t.currentToAct=n;const s=ct(t.seats,n);return t.lastAggressorIndex=s,t}function R(e){const t=C(e),n=t.seats.filter(a=>!a.hasFolded&&a.hole.length===2);if(n.length===1){const a=H(t.pot.main);n[0].stack+=t.pot.main-a}else{for(;t.community.length<5;)t.community.push(v(t.deck));const a=it(t);for(const i of a){if(i.amount<=0||i.eligibleSeatIdxs.length===0)continue;const f=H(i.amount),o=i.amount-f,c=i.eligibleSeatIdxs.filter(d=>t.seats[d].hole.length===2).map(d=>({idx:d,eval:tt([...t.seats[d].hole,...t.community])}));let l=null,u=[];const h={high_card:0,pair:1,two_pair:2,three_kind:3,straight:4,flush:5,full_house:6,four_kind:7,straight_flush:8};for(const d of c){const g=h[d.eval.class];if(!l)l={classIdx:g,ranks:d.eval.ranks},u=[d.idx];else{const A=g-l.classIdx,S=A===0?ot(d.eval.ranks,l.ranks):A;S>0?(l={classIdx:g,ranks:d.eval.ranks},u=[d.idx]):S===0&&u.push(d.idx)}}const k=Math.floor(o/u.length);let x=o-k*u.length;for(const d of u)t.seats[d].stack+=k;x>0&&lt(u,x,(t.buttonIndex+1)%t.seats.length,t.seats.length,d=>{t.seats[d].stack+=1})}}t.status="hand_over",t.currentToAct=null,t.street="showdown";const s=B(t.seats,t.buttonIndex);return s!=null&&(t.buttonIndex=s),t.seats.filter(a=>a.stack>0).length<2&&(t.gameOver=!0),t}function ot(e,t){const n=Math.max(e.length,t.length);for(let s=0;s<n;s+=1){const r=e[s]??-1,a=t[s]??-1;if(r!==a)return r-a}return 0}function it(e){const t=e.seats.map((r,a)=>({idx:a,total:Math.max(0,Math.floor(r.totalCommitted))})).filter(r=>r.total>0).sort((r,a)=>r.total-a.total);if(t.length===0)return[];const n=[];let s=0;for(let r=0;r<t.length;r+=1){const a=t[r].total,i=a-s;if(i>0){const f=t.slice(r).map(l=>l.idx),o=i*f.length,c=f.filter(l=>!e.seats[l].hasFolded);n.push({amount:o,eligibleSeatIdxs:c}),s=a}}return n}function ct(e,t){const n=e.length;for(let s=1;s<=n;s+=1){const r=(t-s+n)%n,a=e[r];if(!a.hasFolded&&!a.isAllIn)return r}return null}function lt(e,t,n,s,r){let a=n;for(;t>0;){const i=e.find(f=>f===a);if(i!=null&&(r(i),t-=1,t===0))break;a=(a+1)%s}}function H(e){const t=F.poker.rakePercent;let n=Math.floor(e*t);return Math.max(0,n)}const ut=Object.fromEntries(["2","3","4","5","6","7","8","9","10","J","Q","K","A"].map((e,t)=>[e,t]));function m(e){return ut[e]}function ft(e,t){return e.suit===t.suit}function ht(e){const t=new Map;for(const n of e)t.set(n.rank,(t.get(n.rank)??0)+1);return t}function dt(e){const t=new Map;for(const n of e)t.set(n.suit,(t.get(n.suit)??0)+1);return t}function mt(e){return e.length===0?null:e.map(t=>t.rank).sort((t,n)=>m(n)-m(t))[0]??null}function pt(e,t){const n=dt([...e,...t]);for(const[,s]of n)if(s>=4)return!0;return!1}function kt(e,t){const n=Array.from(new Set([...e,...t].map(s=>m(s.rank)))).sort((s,r)=>s-r);for(let s=0;s+3<n.length;s+=1){const r=n[s],a=n[s+1],i=n[s+2],f=n[s+3];if(a===r+1&&i===a+1&&f===i+1)return!0}return!!(n.includes(m("A"))&&n.includes(m("2"))&&n.includes(m("3"))&&n.includes(m("4")))}function gt(e,t){const n=ht([...e,...t]),s=mt(t);let r=!1,a=!1,i=!1,f=0;for(const[,l]of n)l===3&&(i=!0),l===2&&(f+=1);f>=1&&(r=!0),f>=2&&(a=!0);let o=!1,c=!1;if(r)if(t.length>=3){if(s&&e.find(l=>l.rank===s)!=null&&(o=!0),e.length===2&&e[0].rank===e[1].rank){const l=m(e[0].rank),u=Math.max(...t.map(h=>m(h.rank)));l>u&&(c=!0)}}else e.length===2&&e[0].rank===e[1].rank&&(c=!0);return{pair:r,topPair:o,overPair:c,twoPair:a,trips:i}}function xt(e){const[t,n]=e,s=m(t.rank),r=m(n.rank),a=Math.max(s,r),i=Math.min(s,r),f=t.rank===n.rank,o=ft(t,n),c=Math.abs(s-r);return f&&s>=m("J")||o&&(t.rank==="A"&&n.rank==="K"||n.rank==="A"&&t.rank==="K")?"premium":f&&s>=m("9")||a>=m("A")&&i>=m("Q")&&o||a>=m("A")&&i>=m("K")?"strong":f||o&&c<=2&&a>=m("7")&&i>=m("4")?"speculative":"trash"}function bt(e,t){const n=e.seats.length,s=(e.buttonIndex+1)%n,r=(e.buttonIndex+2)%n;if(t===s||t===r)return"blinds";const a=(r+1)%n;let i=t-a;return i<0&&(i+=n),i<=1?"early":i<=n-3?"middle":"late"}function vt(e,t="tight"){const n=new Set(st(e)),s=e.currentToAct??0,r=e.seats[s],a=r.hole,i=e.community,f=Math.max(0,e.betToCall-r.committedThisStreet),o=bt(e,s),c=e.lastRaiseAmount||e.rules.bigBlind,l=Math.max(1,e.rules.bigBlind),u=e.seats.map((p,M)=>M===s||p.hasFolded?0:p.stack).filter(p=>p>0),h=Math.min(r.stack,u.length?Math.max(...u):r.stack),k=h/l,x=e.pot.main+f,d=x>0?h/x:1/0;if(e.street==="preflop"){const p=xt(a),M=t==="loose"||p==="premium"||p==="strong"&&(o==="late"||o==="middle");if(f>0){if(k<=20&&n.has("raise")&&(M||p==="speculative"&&o==="late"))return{type:"raise",amount:Math.max(0,r.stack-f)};if(M&&n.has("raise")){const y=Math.max(l,c),Q=Math.max(Math.floor(y*1.5),l),U=Math.max(l*3,l),Mt=e.betToCall<=l?U:Q,j=Math.max(Math.min(Mt-f,r.stack-f),l);return(f+j)/Math.max(1,r.stack)>.5&&p==="speculative"?n.has("call")?{type:"call"}:{type:"fold"}:{type:"raise",amount:j}}return p!=="trash"&&n.has("call")?{type:"call"}:n.has("fold")?{type:"fold"}:n.has("check")?{type:"check"}:{type:"call"}}else{if(M&&n.has("bet")){if(k<=12&&(p==="premium"||p==="strong"))return{type:"bet",amount:r.stack};const y=Math.max(l*3,l);return{type:"bet",amount:Math.min(y,r.stack)}}return n.has("check")?{type:"check"}:n.has("call")?{type:"call"}:{type:"fold"}}}const g=gt(a,i),A=pt(a,i),S=kt(a,i),N=g.trips||g.twoPair||g.overPair,L=g.topPair||g.pair,J=A||S,D=e.pot.main;if(f>0){if(N&&n.has("raise")){if(k<=20||d<=2)return{type:"raise",amount:Math.max(0,r.stack-f)};const p=Math.max(l,c),M=Math.max(Math.floor(p*1.5),l),y=Math.max(Math.floor((D+f)*(t==="tight"?.7:.9)),M);return{type:"raise",amount:Math.min(y,Math.max(0,r.stack-f))}}return(N||L||J)&&n.has("call")?{type:"call"}:n.has("fold")?{type:"fold"}:n.has("call")?{type:"call"}:{type:"check"}}else{if(N&&n.has("bet")){if(k<=20||d<=2)return{type:"bet",amount:r.stack};const p=Math.max(Math.floor(D*.66),l);return{type:"bet",amount:Math.min(p,r.stack)}}if((L||J)&&n.has("bet")&&Math.random()<.4){const p=Math.max(Math.floor(D*.5),l);return{type:"bet",amount:Math.min(p,r.stack)}}return n.has("check")?{type:"check"}:n.has("call")?{type:"call"}:{type:"fold"}}}const E=self;E.onmessage=e=>{const t=e.data;if(!(!t||t.type!=="run"))try{const s={type:"done",result:At(t.options,(r,a)=>{const i={type:"progress",completed:r,total:a};E.postMessage(i)})};E.postMessage(s)}catch(n){const s={type:"error",error:n.message};E.postMessage(s)}};function At(e,t){const{hands:n,seats:s,startingStack:r}=e,a=Array.from({length:Math.max(0,s-1)},(o,c)=>c+1);let i=et(s,a,r);const f=Math.max(1,Math.floor(n/20));for(let o=0;o<n;o+=1){i=nt(i);let c=2e3;for(;i.status==="in_hand"&&c-- >0;)i=rt(i,vt(i,"tight"));((o+1)%f===0||o+1===n)&&t(o+1,n)}return{endingStacks:i.seats.map(o=>o.stack),handsPlayed:n}}})();
